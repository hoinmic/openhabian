import org.openhab.model.script.actions.Timer

val logName = "dehumidifier"

var Timer timer = null

val MAX_HUMIDITY = 65
val DEHUMIDIFIER_ON_TIME_H = 2
val DEHUMIDIFIER_MIN_POWER_CONSUMPTION_W = 400
val DEHUMIDIFIER_MIN_POWER_WATER_TANK_FULL_W = 50


//------------------------------------------------------------
// Startup
rule "Startup"
when
  System started
then
  dehumidifier_switch.sendCommand(OFF)
  maxHumidity = MAX_HUMIDITY
  dehumidifier_status.postUpdate("OK")
end

//------------------------------------------------------------
// Power switch changes
rule "Turn OFF"
when
  Item dehumidifier_switch changed to OFF
then
  dehumidifier_switch.sendCommand(OFF)
  logInfo(logName, "Send command turn off")
end

rule "Turn ON"
when
  Item dehumidifier_switch changed to ON
then
  dehumidifier_switch.sendCommand(ON)
  logInfo(logName, "Send command turn on")

  // After a timeout, turn the dehumidifier off
  if (timer == null)
  {
    timer = createTimer(now.plusHours(DEHUMIDIFIER_ON_TIME_H)) [|
          dehumidifier_switch.postUpdate(OFF)
          logInfo(logName, "Timer expiration, turned OFF")
          timer = null   // reset the timer
      ]
  }
end

//------------------------------------------------------------
// Manually action: Handle local button (power switch)
rule "Local button"
when
  Item dehumidifier_relay changed
then
  // Manually turned on?
  if ((dehumidifier_relay.state.toString == "true") &&
      (dehumidifier_switch.state == OFF ))
  {
    dehumidifier_switch.postUpdate(ON)
    logInfo(logName, "Locally turned ON")
  }
  // Manually turned off?
  if ((dehumidifier_relay.state.toString == "false") &&
      (dehumidifier_switch.state == ON ))
  {
    dehumidifier_switch.postUpdate(OFF)
    logInfo(logName, "Locally turned OFF")
  }
end

//------------------------------------------------------------
// Automatic action: Exceed maximum humidity (low tariff)
rule "Maximum Humidity"
when
  Item humidity_htShelly_01 changed or
  Item low_tariff changed or
  Item maxHumidity changed
then
  if (humidity_htShelly_01 >= maxHumidity)
  {
    if (low_tariff.state.toString == "TRUE")
    {
      dehumidifier_switch.postUpdate(ON)
      logInfo(logName, "Start dehumidifier. Exceed maximum humidity. Low tariff. Humidity: " + humidity_htShelly_01)
    }
    else
    {
      dehumidifier_switch.postUpdate(OFF)
      logInfo(logName, "Standby dehumidifier. High tariff. Humidity: " + humidity_htShelly_01)
    }
  }
  else
  {
    logInfo(logName, "Humidity low. No action required. Humidity: " + humidity_htShelly_01)
  }
end

//------------------------------------------------------------
// Automatic action: Massive exceed maximum humidity
rule "Maximum Humidity"
when
  Item humidity_htShelly_01 changed or
  Item maxHumidity changed or
  Item dehumidifier_switch changed    // if dehumidifier in some way get switched off (ex. timer expired ...)
then
  if (humidity_htShelly_01 >= (maxHumidity+5))
  {
    dehumidifier_switch.postUpdate(ON)
    logInfo(logName, "Start dehumidifier. Massive exceed of maximum humidity. Humidity: " + humidity_htShelly_01)
  }
end


//------------------------------------------------------------
// Dehumidifier Status
rule "Status Dehumidifier"
when
  System started or
  Item dehumidifier_power changed or
  Item dehumidifier_switch changed
then
  if (dehumidifier_network_status.state.toString == "ON")
  {
    if (dehumidifier_switch.state == ON )
    {
      if (dehumidifier_power > DEHUMIDIFIER_MIN_POWER_CONSUMPTION_W)
      {
        dehumidifier_status.postUpdate("OK")
        logInfo (logName, "Dehumidifier is working in normal range: "+dehumidifier_power+"W")
      } 
      else if (dehumidifier_power > DEHUMIDIFIER_MIN_POWER_WATER_TANK_FULL_W)
      {
        dehumidifier_status.postUpdate("Water tank full")
        logInfo (logName, "Water tank full: "+dehumidifier_power+"W")
      }
      else
      {
        dehumidifier_status.postUpdate("Dehumidifier Error")
        logInfo (logName, "Dehumidifier Error: "+dehumidifier_power+"W")
      }
    }
    else
    {
      logInfo (logName, "Dehumidifier off: "+dehumidifier_power+"W")
    }
  }
  else
  {
    logInfo (logName, "No connection to dehumidifier switch")
  }
end